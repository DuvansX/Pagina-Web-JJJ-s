<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio Sesi√≥n - Registro</title>
    <link rel="icon" href="Imagenes/Logo Restaurante.PNG">
    <link rel="stylesheet" href="CSS/InicioSs.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

</head>
<body class="locked">
    <!-- Pantalla de carga -->
    <div id="loading-screen">
      <i class='bx bxs-user-circle'></i>
    </div>

    <!-- Bot√≥n de retroceso -->
    <button class="back-btn" onclick="window.history.back()">
        <i class='bx bx-x'></i>
    </button>

<script>
    window.addEventListener("load", function() {
        let loadingScreen = document.getElementById("loading-screen");
        loadingScreen.classList.add("hidden");
        setTimeout(() => {
            loadingScreen.style.display = "none";
        }, 1000);
    });
</script>

    <div class="wrapper">
        <div class="form-container">
            <!-- FORMULARIO DE LOGIN -->
            <form id="loginForm" class="form active">
                <h2>Inicia Sesi√≥n</h2>
                <div class="input-field">
                    <input type="email" id="loginEmail" required>
                    <label for="loginEmail">Escribe tu email</label>
                    <p class="error" id="loginEmailError">Por favor, introduce un correo v√°lido.</p>
                </div>
                <div class="input-field">
                    <input type="password" id="loginPassword" required minlength="6">
                    <label for="loginPassword">Escribe tu contrase√±a</label>
                    <p class="error" id="loginPasswordError">La contrase√±a debe tener al menos 6 caracteres.</p>
                </div>
                <div class="forget">
                    <label for="remember">
                        <input type="checkbox" id="remember">
                        <p>Recordar</p>
                    </label>
                    <a href="#" id="forgotPasswordLink" style="color: #667eea; text-decoration: none; font-size: 14px;">
    ¬øOlvidaste tu contrase√±a?
</a>
                </div>
                <button type="submit">Entrar</button>
                <div class="social-buttons">
                    <button type="button" id="googleSignInButton" class="google-button">
                        <img src="Imagenes/Google.png" alt="Google" class="social-icon"> Iniciar sesi√≥n con Google
                    </button>
                    <button type="button" class="facebook-button">
                        <img src="Imagenes/Facebook.png" alt="Facebook" class="social-icon"> Iniciar sesi√≥n con Facebook
                    </button>
                </div>
                <p class="toggle-link">
                    ¬øNo tienes cuenta? <span onclick="toggleForms()">Crear cuenta</span>
                </p>
            </form>

            <!-- FORMULARIO DE REGISTRO -->
            <form id="registerForm" class="form inactive register-form">
                <h2>Crear Cuenta</h2>
                <div class="input-field">
                    <input type="text" id="registerName" required>
                    <label for="registerName">Nombre completo</label>
                    <p class="error" id="registerNameError">Por favor, introduce tu nombre.</p>
                </div>
                <div class="input-field">
                    <input type="email" id="registerEmail" required>
                    <label for="registerEmail">Correo electr√≥nico</label>
                    <p class="error" id="registerEmailError">Por favor, introduce un correo v√°lido.</p>
                    <p class="success" id="registerEmailSuccess">Correo v√°lido ‚úì</p>
                </div>
                <div class="input-field">
                    <input type="password" id="registerPassword" required minlength="6">
                    <label for="registerPassword">Contrase√±a</label>
                    <p class="error" id="registerPasswordError">La contrase√±a debe tener al menos 6 caracteres.</p>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>
                <div class="input-field">
                    <input type="password" id="confirmPassword" required minlength="6">
                    <label for="confirmPassword">Confirmar contrase√±a</label>
                    <p class="error" id="confirmPasswordError">Las contrase√±as no coinciden.</p>
                    <p class="success" id="confirmPasswordSuccess">Las contrase√±as coinciden ‚úì</p>
                </div>
                <button type="submit">Crear Cuenta</button>
                <p class="toggle-link">
                    ¬øYa tienes cuenta? <span onclick="toggleForms()">Iniciar sesi√≥n</span>
                </p>
            </form>

            <!-- PANEL DE USUARIO LOGUEADO -->
            <div id="userPanel" class="form inactive">
                <div class="user-profile-header">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNmMGYwZjAiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM3IiByPSIxMyIgZmlsbD0iIzk5OSIvPjxwYXRoIGQ9Im0yNSA3NWMwLTE0IDExLTI1IDI1LTI1czI1IDExIDI1IDI1eiIgZmlsbD0iIzk5OSIvPjwvc3ZnPg=='">
                        <button class="change-photo-btn" onclick="changeProfilePhoto()">
                            <i class='bx bx-camera'></i>
                        </button>
                    </div>
                    <h2 id="userName">Usuario</h2>
                    <p id="userEmail" class="user-email">email@example.com</p>
                    <div class="user-status">
                        <span id="userStatus" class="status-badge">‚úÖ Perfil Completo</span>
                    </div>
                </div>

                <div class="user-info-section">
                    <h3>Informaci√≥n Personal</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <i class='bx bx-phone'></i>
                            <div>
                                <label>Tel√©fono</label>
                                <span id="userPhone">No registrado</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-id-card'></i>
                            <div>
                                <label>Documento</label>
                                <span id="userDocument">No registrado</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-map'></i>
                            <div>
                                <label>Ubicaci√≥n</label>
                                <span id="userLocation">No registrada</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-home'></i>
                            <div>
                                <label>Direcci√≥n</label>
                                <span id="userAddress">No registrada</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="user-actions">
                    <button type="button" class="edit-profile-btn" onclick="editProfile()">
                        <i class='bx bx-edit'></i> Editar Perfil
                    </button>
                    <button type="button" class="logout-btn" onclick="logoutUser()">
                        <i class='bx bx-log-out'></i> Cerrar Sesi√≥n
                    </button>
                </div>

                <div class="account-info">
                    <small>Cuenta creada: <span id="accountCreated">--</span></small><br>
                    <small>√öltimo acceso: <span id="lastLogin">--</span></small>
                </div>
            </div>

            <!-- FORMULARIO DE DATOS ADICIONALES -->
            <form id="additionalDataForm" class="form inactive additional-data-form">
                <h2>Completa tu Perfil</h2>
                <p class="subtitle">Necesitamos algunos datos adicionales para personalizar tu experiencia</p>
                
                <!-- Tel√©fono -->
                <div class="phone-input-container">
                    <div class="input-field country-code">
                        <select id="countryCode" required>
                            <option value="+57">üá®üá¥ +57</option>
                        </select>
                        <label for="countryCode">Pa√≠s</label>
                    </div>
                    <div class="input-field phone-number">
                        <input type="tel" id="phoneNumber" required maxlength="10" pattern="[3][0-9]{9}">
                        <label for="phoneNumber">N√∫mero de tel√©fono</label>
                        <p class="error" id="phoneError">Ingresa un n√∫mero v√°lido (debe iniciar con 3)</p>
                        <p class="success" id="phoneSuccess">N√∫mero v√°lido ‚úì</p>
                    </div>
                </div>

                <!-- Documento -->
                <div class="document-container">
                    <div class="input-field document-type">
                        <select id="documentType" required>
                            <option value="">Tipo</option>
                            <option value="CC">C√©dula</option>
                            <option value="TI">Tarjeta ID</option>
                            <option value="CE">C√©dula Ext</option>
                            <option value="PP">Pasaporte</option>
                        </select>
                        <label for="documentType">Documento</label>
                    </div>
                    <div class="input-field document-number">
                        <input type="text" id="documentNumber" required maxlength="15" pattern="[0-9]+">
                        <label for="documentNumber">N√∫mero de documento</label>
                        <p class="error" id="documentError">Solo n√∫meros, sin puntos ni comas</p>
                        <p class="success" id="documentSuccess">Documento v√°lido ‚úì</p>
                    </div>
                </div>

                <!-- Ubicaci√≥n -->
                <div class="department-city-container">
                    <div class="input-field department-field">
                        <select id="department" required>
                            <option value="">Departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atl√°ntico">Atl√°ntico</option>
                            <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                            <option value="Bol√≠var">Bol√≠var</option>
                            <option value="Boyac√°">Boyac√°</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquet√°">Caquet√°</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Choc√≥">Choc√≥</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guain√≠a">Guain√≠a</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nari√±o">Nari√±o</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quind√≠o">Quind√≠o</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaup√©s">Vaup√©s</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        <label for="department">Departamento</label>
                    </div>
                    <div class="input-field city-field">
                        <input type="text" id="city" required>
                        <label for="city">Ciudad</label>
                        <p class="error" id="cityError">Por favor, ingresa tu ciudad</p>
                    </div>
                </div>

                <!-- Direcci√≥n -->
                <div class="input-field">
                    <input type="text" id="address" required>
                    <label for="address">Direcci√≥n completa</label>
                    <p class="error" id="addressError">Por favor, ingresa tu direcci√≥n</p>
                </div>

                <button type="submit">Guardar y Continuar</button>
                <button type="button" class="skip-button" onclick="skipAdditionalData()">Completar m√°s tarde</button>
            </form>

            <!-- FORMULARIO DE EDICI√ìN DE PERFIL -->
            <form id="editProfileForm" class="form inactive edit-profile-form">
                <h2>Editar Perfil</h2>
                <div class="input-field">
                    <input type="text" id="editName" required>
                    <label for="editName">Nombre completo</label>
                </div>
                
                <div class="phone-input-container">
                    <div class="input-field country-code">
                        <select id="editCountryCode" required>
                            <option value="+57">üá®üá¥ +57</option>
                        </select>
                        <label for="editCountryCode">Pa√≠s</label>
                    </div>
                    <div class="input-field phone-number">
                        <input type="tel" id="editPhoneNumber" required maxlength="10" pattern="[3][0-9]{9}">
                        <label for="editPhoneNumber">N√∫mero de tel√©fono</label>
                        <p class="error" id="editPhoneError">Ingresa un n√∫mero v√°lido (debe iniciar con 3)</p>
                    </div>
                </div>

                <div class="document-container">
                    <div class="input-field document-type">
                        <select id="editDocumentType" required>
                            <option value="">Tipo</option>
                            <option value="CC">C√©dula</option>
                            <option value="TI">Tarjeta ID</option>
                            <option value="CE">C√©dula Ext</option>
                            <option value="PP">Pasaporte</option>
                        </select>
                        <label for="editDocumentType">Documento</label>
                    </div>
                    <div class="input-field document-number">
                        <input type="text" id="editDocumentNumber" required maxlength="15" pattern="[0-9]+">
                        <label for="editDocumentNumber">N√∫mero de documento</label>
                        <p class="error" id="editDocumentError">Solo n√∫meros, sin puntos ni comas</p>
                    </div>
                </div>

                <div class="department-city-container">
                    <div class="input-field department-field">
                        <select id="editDepartment" required>
                            <option value="">Departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atl√°ntico">Atl√°ntico</option>
                            <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                            <option value="Bol√≠var">Bol√≠var</option>
                            <option value="Boyac√°">Boyac√°</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquet√°">Caquet√°</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Choc√≥">Choc√≥</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guain√≠a">Guain√≠a</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nari√±o">Nari√±o</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quind√≠o">Quind√≠o</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaup√©s">Vaup√©s</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        <label for="editDepartment">Departamento</label>
                    </div>
                    <div class="input-field city-field">
                        <input type="text" id="editCity" required>
                        <label for="editCity">Ciudad</label>
                        <p class="error" id="editCityError">Por favor, ingresa tu ciudad</p>
                    </div>
                </div>

                <div class="input-field">
                    <input type="text" id="editAddress" required>
                    <label for="editAddress">Direcci√≥n completa</label>
                    <p class="error" id="editAddressError">Por favor, ingresa tu direcci√≥n</p>
                </div>

                <button type="submit">Guardar Cambios</button>
                <button type="button" class="cancel-button" onclick="cancelEditProfile()">Cancelar</button>
            </form>
        </div>
    </div>
    <!-- Modal para recuperaci√≥n de contrase√±a -->
<div id="passwordResetModal" class="reset-modal">
  <div class="reset-modal-content">
    <span class="close-reset-modal">&times;</span>
    <div class="reset-modal-header">
      <i class='bx bx-lock-alt'></i>
      <h3>Recuperar contrase√±a</h3>
    </div>
    <div class="reset-modal-body">
      <div class="input-field">
        <input type="email" id="resetEmail" required>
        <label for="resetEmail">Correo electr√≥nico registrado</label>
        <p class="error" id="resetEmailError"></p>
      </div>
    </div>
    <div class="reset-modal-footer">
      <button id="cancelResetBtn" class="cancel-btn">Cancelar</button>
      <button id="confirmResetBtn" class="confirm-btn">Enviar enlace</button>
    </div>
  </div>
</div>

    <script>
    // ========== CONFIGURACI√ìN DE FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCbemUTCYHJYcbiX5U4DaQuaJa8Mh6EdyY",
        authDomain: "login-pagina-9a2b2.firebaseapp.com",
        projectId: "login-pagina-9a2b2",
        storageBucket: "login-pagina-9a2b2.firebasestorage.app",
        messagingSenderId: "676654795358",
        appId: "1:676654795358:web:c455962c22670fd0b002cf",
        measurementId: "G-TE86DMGMBV"
    };

    // Inicializar Firebase
    let app, auth, db, storage;
    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        console.log('‚úÖ Firebase inicializado correctamente');
    } catch (error) {
        console.error('‚ùå Error al inicializar Firebase:', error);
        alert('Error de configuraci√≥n de Firebase. Revisa la consola para m√°s detalles.');
    }

    // ========== VARIABLES GLOBALES ==========
    let currentForm = 'login'; // 'login', 'register', 'additionalData', 'editProfile'
    let currentUser = null;

    // ========== PANTALLA DE CARGA ==========
    window.addEventListener('load', function() {
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.add('hidden');
            document.body.classList.remove('locked');
        }, 2000);
    });

    // ========== FUNCIONES DE NAVEGACI√ìN ==========
    function showForm(formName) {
        // Ocultar todos los formularios
        document.querySelectorAll('.form').forEach(form => {
            form.classList.remove('active');
            form.classList.add('inactive');
        });

        // Mostrar formulario espec√≠fico
        let targetForm;
        if (formName === 'user') {
            targetForm = document.getElementById('userPanel');
        } else if (formName === 'editProfile') {
            targetForm = document.getElementById('editProfileForm');
        } else {
            targetForm = document.getElementById(formName + 'Form');
        }
        
        if (targetForm) {
            targetForm.classList.remove('inactive');
            targetForm.classList.add('active');
            currentForm = formName;
        }
    }

    function toggleForms() {
        if (currentForm === 'login') {
            showForm('register');
        } else {
            showForm('login');
        }
        clearFormErrors();
    }

    function clearFormErrors() {
        document.querySelectorAll('.error').forEach(error => error.classList.remove('show'));
        document.querySelectorAll('.success').forEach(success => success.classList.remove('show'));
    }

    // ========== FUNCIONES DE VALIDACI√ìN ==========
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function validateColombianPhone(phone) {
        const phoneRegex = /^3[0-9]{9}$/;
        return phoneRegex.test(phone);
    }

    function validateDocument(docNumber) {
        const docRegex = /^[0-9]+$/;
        return docRegex.test(docNumber) && docNumber.length >= 6 && docNumber.length <= 15;
    }

    function checkPasswordStrength(password) {
        const strengthElement = document.getElementById('passwordStrength');
        let strength = 0;
        let message = '';
        
        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        if (password.length < 6) {
            strengthElement.className = 'password-strength weak';
            message = 'Muy d√©bil - M√≠nimo 6 caracteres';
        } else if (strength <= 2) {
            strengthElement.className = 'password-strength weak';
            message = 'D√©bil - Usa may√∫sculas, n√∫meros y s√≠mbolos';
        } else if (strength <= 3) {
            strengthElement.className = 'password-strength medium';
            message = 'Media - Agrega m√°s variedad';
        } else {
            strengthElement.className = 'password-strength strong';
            message = 'Fuerte ‚úì';
        }
        
        strengthElement.textContent = message;
    }

    // ========== FUNCIONES DE AUTENTICACI√ìN ==========
    async function registerWithFirebase(email, password, name) {
        try {
            console.log('üìù Creando usuario:', email);
            
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            console.log('‚úÖ Usuario creado en Auth:', user.uid);
            
            await user.updateProfile({ displayName: name });
            
            const userData = {
                name: name,
                email: email,
                createdAt: new Date().toISOString(),
                emailVerified: false,
                provider: 'email',
                uid: user.uid,
                profileComplete: false,
                photoURL: null
            };
            
            await db.collection('users').doc(user.uid).set(userData);
            console.log('‚úÖ Usuario guardado en Firestore');
            
            try {
                await user.sendEmailVerification();
                console.log('üìß Email de verificaci√≥n enviado');
            } catch (emailError) {
                console.warn('‚ö†Ô∏è No se pudo enviar email de verificaci√≥n:', emailError);
            }
            
            return {
                success: true,
                user: userData
            };
        } catch (error) {
            console.error('‚ùå Error en registro:', error);
            return {
                success: false,
                error: error.code,
                message: getFirebaseErrorMessage(error.code)
            };
        }
    }

    async function loginWithEmail(email, password) {
        try {
            console.log('üîê Intentando login con:', email);
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            console.log('‚úÖ Login exitoso:', user.uid);
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            
            return {
                success: true,
                user: {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName || userData?.name || 'Usuario',
                    emailVerified: user.emailVerified,
                    profileComplete: userData?.profileComplete || false,
                    ...userData
                }
            };
        } catch (error) {
            console.error('‚ùå Error en login:', error);
            return {
                success: false,
                error: error.code,
                message: getFirebaseErrorMessage(error.code)
            };
        }
    }

    async function loginWithGoogle() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            
            console.log('‚úÖ Login con Google exitoso:', user.uid);
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            let userData;
            
            if (userDoc.exists) {
                userData = userDoc.data();
                await db.collection('users').doc(user.uid).update({
                    lastLogin: new Date().toISOString()
                });
            } else {
                userData = {
                    name: user.displayName,
                    email: user.email,
                    createdAt: new Date().toISOString(),
                    provider: 'google',
                    emailVerified: user.emailVerified,
                    photoURL: user.photoURL,
                    uid: user.uid,
                    profileComplete: false,
                    lastLogin: new Date().toISOString()
                };
                
                await db.collection('users').doc(user.uid).set(userData);
            }
            
            return {
                success: true,
                user: {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName,
                    photoURL: user.photoURL,
                    provider: 'google',
                    emailVerified: user.emailVerified,
                    profileComplete: userData.profileComplete || false,
                    ...userData
                }
            };
        } catch (error) {
            console.error('‚ùå Error en login con Google:', error);
            return {
                success: false,
                error: error.code,
                message: getFirebaseErrorMessage(error.code)
            };
        }
    }

    async function saveAdditionalData(userData) {
        try {
            const user = auth.currentUser;
            if (!user) throw new Error('No hay usuario autenticado');
            
            const additionalData = {
                phone: userData.phone,
                documentType: userData.documentType,
                documentNumber: userData.documentNumber,
                department: userData.department,
                city: userData.city,
                address: userData.address,
                profileComplete: true,
                profileCompletedAt: new Date().toISOString()
            };
            
            await db.collection('users').doc(user.uid).update(additionalData);
            console.log('‚úÖ Datos adicionales guardados');
            
            return { success: true };
        } catch (error) {
            console.error('‚ùå Error guardando datos adicionales:', error);
            return { success: false, message: error.message };
        }
    }

    function getFirebaseErrorMessage(errorCode) {
        const messages = {
            'auth/user-not-found': 'No existe una cuenta con este correo electr√≥nico.',
            'auth/wrong-password': 'Contrase√±a incorrecta.',
            'auth/email-already-in-use': 'Ya existe una cuenta con este correo electr√≥nico.',
            'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres.',
            'auth/invalid-email': 'El correo electr√≥nico no es v√°lido.',
            'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde.',
            'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet.',
            'auth/popup-closed-by-user': 'Ventana de autenticaci√≥n cerrada.',
            'auth/cancelled-popup-request': 'Solicitud cancelada.',
            'default': 'Error de autenticaci√≥n. Intenta nuevamente.'
        };
        return messages[errorCode] || messages['default'];
    }

    // ========== MANEJO POST-LOGIN MODIFICADO ==========
    function handlePostLogin(user) {
        currentUser = user;
        
        // Mostrar pantalla de carga
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.style.display = 'flex';
        loadingScreen.classList.remove('hidden');
        document.body.classList.add('locked');
        
        setTimeout(() => {
            // Ocultar pantalla de carga
            loadingScreen.classList.add('hidden');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                document.body.classList.remove('locked');
            }, 1000);
            
            if (!user.profileComplete) {
                console.log('üìã Usuario necesita completar perfil');
                showForm('additionalData');
            } else {
                console.log('‚úÖ Usuario con perfil completo');
                showUserPanel(user);
            }
        }, 1500);
    }

    function showUserPanel(user) {
        console.log('üë§ Mostrando panel de usuario:', user.name);
        
        document.getElementById('userName').textContent = user.name || 'Usuario';
        document.getElementById('userEmail').textContent = user.email || '';
        
        const avatar = document.getElementById('userAvatar');
        if (user.photoURL) {
            avatar.src = user.photoURL;
        }
        
        const statusElement = document.getElementById('userStatus');
        if (user.profileComplete) {
            statusElement.textContent = '‚úÖ Perfil Completo';
            statusElement.className = 'status-badge complete';
        } else {
            statusElement.textContent = '‚ö†Ô∏è Perfil Incompleto';
            statusElement.className = 'status-badge incomplete';
        }
        
        document.getElementById('userPhone').textContent = user.phone || 'No registrado';
        document.getElementById('userDocument').textContent = 
            user.documentType && user.documentNumber ? 
            `${user.documentType} ${user.documentNumber}` : 'No registrado';
        document.getElementById('userLocation').textContent = 
            user.city && user.department ? 
            `${user.city}, ${user.department}` : 'No registrada';
        document.getElementById('userAddress').textContent = user.address || 'No registrada';
        
        if (user.createdAt) {
            const createdDate = new Date(user.createdAt).toLocaleDateString('es-CO');
            document.getElementById('accountCreated').textContent = createdDate;
        }
        
        if (user.lastLogin) {
            const lastLoginDate = new Date(user.lastLogin).toLocaleString('es-CO');
            document.getElementById('lastLogin').textContent = lastLoginDate;
        }
        
        showForm('user');
    }

    function skipAdditionalData() {
        if (currentUser) {
            console.log('‚è≠Ô∏è Usuario salt√≥ datos adicionales');
            showUserPanel(currentUser);
        }
    }

    // ========== FUNCIONES DEL PANEL DE USUARIO ==========
    function editProfile() {
        if (!currentUser) return;
        
        document.getElementById('editName').value = currentUser.name || '';
        
        if (currentUser.phone) {
            const phone = currentUser.phone.replace('+57', '');
            document.getElementById('editPhoneNumber').value = phone;
        }
        
        if (currentUser.documentType) {
            document.getElementById('editDocumentType').value = currentUser.documentType;
        }
        
        if (currentUser.documentNumber) {
            document.getElementById('editDocumentNumber').value = currentUser.documentNumber;
        }
        
        if (currentUser.department) {
            document.getElementById('editDepartment').value = currentUser.department;
        }
        
        if (currentUser.city) {
            document.getElementById('editCity').value = currentUser.city;
        }
        
        if (currentUser.address) {
            document.getElementById('editAddress').value = currentUser.address;
        }
        
        showForm('editProfile');
    }

    function cancelEditProfile() {
        showUserPanel(currentUser);
    }

    function logoutUser() {
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
            auth.signOut().then(() => {
                console.log('üëã Sesi√≥n cerrada');
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                showForm('login');
                
                document.querySelectorAll('form').forEach(form => form.reset());
                clearFormErrors();
                
                alert('‚úÖ Sesi√≥n cerrada exitosamente');
            }).catch((error) => {
                console.error('Error al cerrar sesi√≥n:', error);
                alert('‚ùå Error al cerrar sesi√≥n');
            });
        }
    }

    function changeProfilePhoto() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = handlePhotoUpload;
        input.click();
    }

    async function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file || !currentUser) return;
        
        if (file.size > 2 * 1024 * 1024) {
            alert('‚ùå La imagen es muy grande. M√°ximo 2MB permitido.');
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            alert('‚ùå Por favor selecciona una imagen v√°lida.');
            return;
        }
        
        try {
            console.log('üì∏ Subiendo foto de perfil...');
            
            const storageRef = storage.ref(`profile_photos/${currentUser.uid}/${Date.now()}_${file.name}`);
            const uploadTask = storageRef.put(file);
            
            const changeBtn = document.querySelector('.change-photo-btn');
            changeBtn.innerHTML = '<i class="bx bx-loader bx-spin"></i>';
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Progreso:', progress.toFixed(0) + '%');
                },
                (error) => {
                    console.error('Error subiendo foto:', error);
                    alert('‚ùå Error subiendo la foto');
                    changeBtn.innerHTML = '<i class="bx bx-camera"></i>';
                },
                async () => {
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        await auth.currentUser.updateProfile({
                            photoURL: downloadURL
                        });
                        
                        await db.collection('users').doc(currentUser.uid).update({
                            photoURL: downloadURL,
                            updatedAt: new Date().toISOString()
                        });
                        
                        document.getElementById('userAvatar').src = downloadURL;
                        currentUser.photoURL = downloadURL;
                        
                        changeBtn.innerHTML = '<i class="bx bx-camera"></i>';
                        
                        console.log('‚úÖ Foto de perfil actualizada');
                        alert('‚úÖ Foto de perfil actualizada correctamente');
                        
                    } catch (error) {
                        console.error('Error actualizando foto:', error);
                        alert('‚ùå Error actualizando la foto');
                        changeBtn.innerHTML = '<i class="bx bx-camera"></i>';
                    }
                }
            );
            
        } catch (error) {
            console.error('Error general subiendo foto:', error);
            alert('‚ùå Error subiendo la foto');
        }
    }

    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Validaci√≥n de email en registro
        document.getElementById('registerEmail')?.addEventListener('input', function() {
            const email = this.value;
            const emailError = document.getElementById('registerEmailError');
            const emailSuccess = document.getElementById('registerEmailSuccess');
            
            if (email && validateEmail(email)) {
                emailError.classList.remove('show');
                emailSuccess.classList.add('show');
            } else if (email) {
                emailSuccess.classList.remove('show');
                emailError.classList.add('show');
            } else {
                emailError.classList.remove('show');
                emailSuccess.classList.remove('show');
            }
        });

        // ... (otros event listeners de validaci√≥n) ...

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('remember').checked;
            const submitButton = this.querySelector('button[type="submit"]');
            
            clearFormErrors();
            
            let hasErrors = false;
            
            if (!email || !validateEmail(email)) {
                document.getElementById('loginEmailError').classList.add('show');
                hasErrors = true;
            }
            
            if (!password || password.length < 6) {
                document.getElementById('loginPasswordError').classList.add('show');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            submitButton.textContent = 'Iniciando sesi√≥n...';
            submitButton.disabled = true;
            
            const result = await loginWithEmail(email, password);
            
            if (result.success) {
                submitButton.textContent = '¬°Bienvenido!';
                submitButton.style.background = '#28a745';
                
                if (remember) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }
                
                setTimeout(() => {
                    handlePostLogin(result.user);
                }, 1000);
                
            } else {
                submitButton.textContent = 'Error de acceso';
                submitButton.style.background = '#dc3545';
                
                if (result.error === 'auth/user-not-found') {
                    document.getElementById('loginEmailError').textContent = result.message;
                    document.getElementById('loginEmailError').classList.add('show');
                } else if (result.error === 'auth/wrong-password') {
                    document.getElementById('loginPasswordError').textContent = result.message;
                    document.getElementById('loginPasswordError').classList.add('show');
                }
                
                setTimeout(() => {
                    submitButton.textContent = 'Entrar';
                    submitButton.disabled = false;
                    submitButton.style.background = '';
                }, 2000);
            }
        });

        // ... (otros event listeners de formularios) ...

        document.getElementById('googleSignInButton').addEventListener('click', async function() {
            const button = this;
            button.textContent = 'Conectando con Google...';
            button.disabled = true;
            
            const result = await loginWithGoogle();
            
            if (result.success) {
                button.textContent = '¬°Bienvenido!';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    handlePostLogin(result.user);
                }, 1000);
            } else {
                button.textContent = 'Error con Google';
                button.style.background = '#dc3545';
                
                setTimeout(() => {
                    button.textContent = 'Iniciar sesi√≥n con Google';
                    button.disabled = false;
                    button.style.background = '';
                }, 2000);
            }
        });

        // Inicializaci√≥n
        async function checkExistingSession() {
            return new Promise((resolve) => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    unsubscribe();
                    
                    if (user) {
                        console.log('üîç Usuario ya autenticado encontrado:', user.email);
                        
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            const userData = userDoc.data();
                            
                            const completeUser = {
                                uid: user.uid,
                                email: user.email,
                                name: user.displayName || userData?.name || 'Usuario',
                                emailVerified: user.emailVerified,
                                photoURL: user.photoURL || userData?.photoURL,
                                profileComplete: userData?.profileComplete || false,
                                ...userData
                            };
                            
                            currentUser = completeUser;
                            showUserPanel(completeUser);
                            resolve(true);
                        } catch (error) {
                            console.error('Error obteniendo datos del usuario:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('üë§ No hay usuario autenticado');
                        showForm('login');
                        resolve(false);
                    }
                });
            });
        }

        async function init() {
            console.log('üöÄ Inicializando sistema...');
            
            const hasActiveSession = await checkExistingSession();
            
            if (!hasActiveSession) {
                const remembered = localStorage.getItem('rememberedEmail');
                if (remembered) {
                    document.getElementById('loginEmail').value = remembered;
                    document.getElementById('remember').checked = true;
                }
            }
            
            window.toggleForms = toggleForms;
            window.skipAdditionalData = skipAdditionalData;
            window.editProfile = editProfile;
            window.cancelEditProfile = cancelEditProfile;
            window.logoutUser = logoutUser;
            window.changeProfilePhoto = changeProfilePhoto;
            
            console.log('=== SISTEMA LISTO ===');
        }

        init();
    });
    // Modal de recuperaci√≥n
        const modal = document.getElementById('passwordResetModal');
        const resetButton = document.getElementById('forgotPasswordLink');
        const closeModal = document.querySelector('.close-reset-modal'); // Cambiado a la clase correcta
        const sendResetButton = document.getElementById('confirmResetBtn'); // Cambiado al ID correcto
        const cancelButton = document.getElementById('cancelResetBtn'); // A√±adido el bot√≥n cancelar

        resetButton.addEventListener('click', (e) => {
        e.preventDefault();
        modal.style.display = 'block';
        document.getElementById('resetEmail').value = ''; // Limpiar el campo
        document.getElementById('resetEmailError').textContent = '';
        });

        closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
        });

        // A√±adir evento para el bot√≥n Cancelar
        cancelButton.addEventListener('click', () => {
        modal.style.display = 'none';
        });

        sendResetButton.addEventListener('click', async () => {
        const email = document.getElementById('resetEmail').value.trim();
        const errorElement = document.getElementById('resetEmailError');
        
        if (!email || !validateEmail(email)) {
            errorElement.textContent = 'Ingresa un correo v√°lido';
            return;
        }
        
        sendResetButton.textContent = 'Enviando...';
        sendResetButton.disabled = true;
        
        try {
            await auth.sendPasswordResetEmail(email);
            
            // Feedback visual mejorado
            const modalContent = document.querySelector('.reset-modal-content');
            modalContent.innerHTML = `
            <div class="reset-modal-header">
                <i class='bx bx-check-circle success-icon'></i>
                <h3>¬°Enlace enviado!</h3>
            </div>
            <div class="reset-modal-body">
                <p>Revisa tu correo electr√≥nico <strong>${email}</strong> y sigue las instrucciones.</p>
                <p>¬øNo lo ves? Revisa tu carpeta de spam.</p>
            </div>
            <div class="reset-modal-footer">
                <button onclick="document.getElementById('passwordResetModal').style.display='none'" class="confirm-btn">Entendido</button>
            </div>
            `;
            
        } catch (error) {
            sendResetButton.textContent = 'Enviar enlace';
            sendResetButton.disabled = false;
            errorElement.textContent = getFirebaseErrorMessage(error.code);
        }
        });

        // Cierra el modal al hacer clic fuera
        window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
        });

</script>
</body>
</html>