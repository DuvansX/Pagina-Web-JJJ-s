<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio Sesi√≥n</title>
    <link rel="icon" href="Imagenes/Logo Restaurante.PNG">
    <link rel="stylesheet" href="CSS/InicioSs.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
</head>
<body class="locked">
    <!-- Pantalla de carga -->
    <div id="loading-screen">
        <i class='bx bx-conversation'></i>
    </div>

    <div class="wrapper">
        <form id="loginForm" class="active">
            <h2>Inicia Sesi√≥n</h2>
            <div class="input-field">
                <input type="email" id="email" required>
                <label for="email">Escribe tu email</label>
                <p class="error" id="emailError">Por favor, introduce un correo v√°lido.</p>
            </div>
            <div class="input-field">
                <input type="password" id="password" required minlength="6">
                <label for="password">Escribe tu contrase√±a</label>
                <p class="error" id="passwordError">La contrase√±a debe tener al menos 6 caracteres.</p>
            </div>
            <div class="forget">
                <label for="remember">
                    <input type="checkbox" id="remember">
                    <p>Recordar</p>
                </label>
                <a href="#">¬øOlvid√≥ su contrase√±a?</a>
            </div>
            <button type="submit">Entrar</button>
            <div class="social-buttons">
                <button type="button" id="googleSignInButton" class="google-button">
                    <img src="Imagenes/Google.png" alt="Google" class="social-icon"> Iniciar sesi√≥n con Google
                </button>
                <button type="button" class="facebook-button">
                    <img src="Imagenes/Facebook.png" alt="Facebook" class="social-icon"> Iniciar sesi√≥n con Facebook
                </button>
            </div>
            <p class="toggle-link">
                ¬øNo tienes cuenta? <span onclick="toggleForms()">Crear cuenta</span>
            </p>
        </form>
    </div>

    <script>
        // ========== CONFIGURACI√ìN DE FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCbemUTCYHJYcbiX5U4DaQuaJa8Mh6EdyY",
            authDomain: "login-pagina-9a2b2.firebaseapp.com",
            projectId: "login-pagina-9a2b2",
            storageBucket: "login-pagina-9a2b2.firebasestorage.app",
            messagingSenderId: "676654795358",
            appId: "1:676654795358:web:c455962c22670fd0b002cf",
            measurementId: "G-TE86DMGMBV"
        };

        // Inicializar Firebase
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('‚úÖ Firebase inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error al inicializar Firebase:', error);
            console.log('üîß Para configurar Firebase, sigue estos pasos:');
            console.log('1. Ve a https://console.firebase.google.com/');
            console.log('2. Crea un nuevo proyecto');
            console.log('3. Habilita Authentication y Firestore');
            console.log('4. Copia tu configuraci√≥n aqu√≠');
        }

        // ========== PANTALLA DE CARGA ==========
        window.addEventListener('load', function() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.add('hidden');
                document.body.classList.remove('locked');
            }, 2000);
        });

        // ========== FUNCIONES DE FIREBASE ==========
        async function loginWithFirebase(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Obtener datos adicionales del usuario desde Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                return {
                    success: true,
                    user: {
                        uid: user.uid,
                        email: user.email,
                        name: userData?.name || 'Usuario',
                        emailVerified: user.emailVerified,
                        createdAt: userData?.createdAt,
                        lastLogin: new Date().toISOString()
                    }
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.code,
                    message: getFirebaseErrorMessage(error.code)
                };
            }
        }

        async function registerWithFirebase(email, password, name) {
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Actualizar perfil con el nombre
                await user.updateProfile({
                    displayName: name
                });
                
                // Guardar datos adicionales en Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    createdAt: new Date().toISOString(),
                    emailVerified: false
                });
                
                // Enviar email de verificaci√≥n
                await user.sendEmailVerification();
                
                return {
                    success: true,
                    user: {
                        uid: user.uid,
                        email: user.email,
                        name: name,
                        emailVerified: false
                    }
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.code,
                    message: getFirebaseErrorMessage(error.code)
                };
            }
        }

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Guardar o actualizar datos en Firestore
                await db.collection('users').doc(user.uid).set({
                    name: user.displayName,
                    email: user.email,
                    lastLogin: new Date().toISOString(),
                    provider: 'google'
                }, { merge: true });
                
                return {
                    success: true,
                    user: {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName,
                        photoURL: user.photoURL,
                        provider: 'google'
                    }
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.code,
                    message: getFirebaseErrorMessage(error.code)
                };
            }
        }

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'No existe una cuenta con este correo electr√≥nico.',
                'auth/wrong-password': 'Contrase√±a incorrecta.',
                'auth/email-already-in-use': 'Ya existe una cuenta con este correo electr√≥nico.',
                'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres.',
                'auth/invalid-email': 'El correo electr√≥nico no es v√°lido.',
                'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde.',
                'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet.',
                'auth/popup-closed-by-user': 'Ventana de autenticaci√≥n cerrada.',
                'auth/cancelled-popup-request': 'Solicitud cancelada.',
                'default': 'Error de autenticaci√≥n. Intenta nuevamente.'
            };
            return messages[errorCode] || messages['default'];
        }

        // ========== FUNCIONES DE UTILIDAD ==========
        function loadRememberedEmail() {
            const remembered = localStorage.getItem('rememberedEmail');
            if (remembered) {
                document.getElementById('email').value = remembered;
                document.getElementById('remember').checked = true;
            }
        }

        function saveRememberedEmail(email, remember) {
            if (remember) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }
        }

        function saveUserSession(userData) {
            sessionStorage.setItem('currentUser', JSON.stringify(userData));
        }

        function showLoginSuccess(userData) {
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.textContent = '¬°Bienvenido!';
            submitButton.style.background = '#28a745';
            
            setTimeout(() => {
                alert(`¬°Bienvenido ${userData.name}! üéâ\n\n` +
                      `Email: ${userData.email}\n` +
                      `√öltima conexi√≥n: ${new Date().toLocaleString()}\n\n` +
                      `Datos guardados en Firebase ‚úÖ`);
                
                console.log('Usuario autenticado:', userData);
                resetForm();
                
                // Aqu√≠ redirigir√≠as a tu p√°gina principal
                // window.location.href = 'dashboard.html';
            }, 1000);
        }

        function showLoginError(message) {
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.textContent = 'Error de acceso';
            submitButton.style.background = '#dc3545';
            
            setTimeout(() => {
                alert(`‚ùå Error: ${message}`);
                resetForm();
            }, 1000);
        }

        // ========== VALIDACI√ìN DEL FORMULARIO ==========
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const remember = document.getElementById('remember').checked;
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');
            const submitButton = this.querySelector('button[type="submit"]');
            
            // Reset errores
            emailError.classList.remove('show');
            passwordError.classList.remove('show');
            
            let hasErrors = false;
            
            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                emailError.textContent = 'Por favor, introduce un correo v√°lido.';
                emailError.classList.add('show');
                hasErrors = true;
            }
            
            // Validar contrase√±a
            if (!password || password.length < 6) {
                passwordError.textContent = 'La contrase√±a debe tener al menos 6 caracteres.';
                passwordError.classList.add('show');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            // Mostrar estado de carga
            submitButton.textContent = 'Conectando a Firebase...';
            submitButton.disabled = true;
            
            // Intentar login con Firebase
            const result = await loginWithFirebase(email, password);
            
            if (result.success) {
                // LOGIN EXITOSO
                saveUserSession(result.user);
                saveRememberedEmail(email, remember);
                showLoginSuccess(result.user);
            } else {
                // LOGIN FALLIDO
                showLoginError(result.message);
                
                // Mostrar error espec√≠fico en el campo correspondiente
                if (result.error === 'auth/user-not-found') {
                    emailError.textContent = result.message;
                    emailError.classList.add('show');
                } else if (result.error === 'auth/wrong-password') {
                    passwordError.textContent = result.message;
                    passwordError.classList.add('show');
                }
            }
        });

        function resetForm() {
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.textContent = 'Entrar';
            submitButton.disabled = false;
            submitButton.style.background = '';
        }

        // ========== BOTONES SOCIALES ==========
        document.getElementById('googleSignInButton').addEventListener('click', async function() {
            const button = this;
            button.textContent = 'Conectando con Google...';
            button.disabled = true;
            
            const result = await loginWithGoogle();
            
            if (result.success) {
                saveUserSession(result.user);
                showLoginSuccess(result.user);
            } else {
                showLoginError(result.message);
            }
            
            button.textContent = 'Iniciar sesi√≥n con Google';
            button.disabled = false;
        });

        document.querySelector('.facebook-button').addEventListener('click', function() {
            alert('üîß Facebook Login en desarrollo\n\n' +
                  'Para implementar Facebook necesitas:\n' +
                  '‚Ä¢ Habilitar Facebook en Firebase Authentication\n' +
                  '‚Ä¢ Configurar Facebook App ID\n' +
                  '‚Ä¢ Agregar dominio autorizado');
        });

        // ========== FUNCIONES DE DESARROLLO ==========
        function showFirebaseStatus() {
            console.log('=== ESTADO DE FIREBASE ===');
            console.log('Auth:', auth ? '‚úÖ Conectado' : '‚ùå No inicializado');
            console.log('Firestore:', db ? '‚úÖ Conectado' : '‚ùå No inicializado');
            console.log('Usuario actual:', auth?.currentUser || 'No autenticado');
            console.log('Sesi√≥n local:', JSON.parse(sessionStorage.getItem('currentUser') || 'null'));
        }

        async function createTestUser() {
            const email = prompt('Email del usuario de prueba:');
            const password = prompt('Contrase√±a (m√≠nimo 6 caracteres):');
            const name = prompt('Nombre del usuario:') || 'Usuario Test';
            
            if (email && password) {
                const result = await registerWithFirebase(email, password, name);
                if (result.success) {
                    alert(`‚úÖ Usuario ${name} creado exitosamente!\n\nRevisa tu email para verificar la cuenta.`);
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            }
        }

        function toggleForms() {
            alert('üöß P√°gina de registro en desarrollo\n\n¬øQuieres que te ayude a crearla?\n\nMientras tanto, usa createTestUser() en la consola para crear usuarios.');
        }

        // ========== MONITOREO DE AUTENTICACI√ìN ==========
        auth?.onAuthStateChanged(function(user) {
            if (user) {
                console.log('üë§ Usuario autenticado:', user.email);
                // Actualizar √∫ltima conexi√≥n
                if (db) {
                    db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString()
                    }).catch(console.error);
                }
            } else {
                console.log('üë§ Usuario no autenticado');
            }
        });

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadRememberedEmail();
            
            // Funciones disponibles en consola
            window.showFirebaseStatus = showFirebaseStatus;
            window.createTestUser = createTestUser;
            
            console.log('=== SISTEMA DE LOGIN CON FIREBASE ===');
            console.log('üîß Funciones disponibles en consola:');
            console.log('‚Ä¢ showFirebaseStatus() - Ver estado de Firebase');
            console.log('‚Ä¢ createTestUser() - Crear usuario de prueba');
            console.log('\nüìã Para configurar Firebase:');
            console.log('1. Ve a https://console.firebase.google.com/');
            console.log('2. Crea proyecto ‚Üí Habilita Authentication y Firestore');
            console.log('3. Copia tu config en firebaseConfig');
        });
    </script>
</body>
</html>