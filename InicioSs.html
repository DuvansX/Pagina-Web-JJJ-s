<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio Sesi√≥n - Registro</title>
    <link rel="icon" href="Imagenes/Logo Restaurante.PNG">
    <link rel="stylesheet" href="CSS/InicioSs.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

</head>
<body class="locked">
    <!-- Pantalla de carga -->
    <div id="loading-screen">
      <i class='bx bxs-user-circle'></i>
    </div>

<script>
    window.addEventListener("load", function() {
        let loadingScreen = document.getElementById("loading-screen");
        loadingScreen.classList.add("hidden");
        setTimeout(() => {
            loadingScreen.style.display = "none";
        }, 1000);
    });
</script>

    <div class="wrapper">
        <div class="form-container">
            <!-- FORMULARIO DE LOGIN -->
            <form id="loginForm" class="form active">
                <h2>Inicia Sesi√≥n</h2>
                <div class="input-field">
                    <input type="email" id="loginEmail" required>
                    <label for="loginEmail">Escribe tu email</label>
                    <p class="error" id="loginEmailError">Por favor, introduce un correo v√°lido.</p>
                </div>
                <div class="input-field">
                    <input type="password" id="loginPassword" required minlength="6">
                    <label for="loginPassword">Escribe tu contrase√±a</label>
                    <p class="error" id="loginPasswordError">La contrase√±a debe tener al menos 6 caracteres.</p>
                </div>
                <div class="forget">
                    <label for="remember">
                        <input type="checkbox" id="remember">
                        <p>Recordar</p>
                    </label>
                    <a href="#">¬øOlvid√≥ su contrase√±a?</a>
                </div>
                <button type="submit">Entrar</button>
                <div class="social-buttons">
                    <button type="button" id="googleSignInButton" class="google-button">
                        <img src="Imagenes/Google.png" alt="Google" class="social-icon"> Iniciar sesi√≥n con Google
                    </button>
                    <button type="button" class="facebook-button">
                        <img src="Imagenes/Facebook.png" alt="Facebook" class="social-icon"> Iniciar sesi√≥n con Facebook
                    </button>
                </div>
                <p class="toggle-link">
                    ¬øNo tienes cuenta? <span onclick="toggleForms()">Crear cuenta</span>
                </p>
            </form>

            <!-- FORMULARIO DE REGISTRO -->
            <form id="registerForm" class="form inactive register-form">
                <h2>Crear Cuenta</h2>
                <div class="input-field">
                    <input type="text" id="registerName" required>
                    <label for="registerName">Nombre completo</label>
                    <p class="error" id="registerNameError">Por favor, introduce tu nombre.</p>
                </div>
                <div class="input-field">
                    <input type="email" id="registerEmail" required>
                    <label for="registerEmail">Correo electr√≥nico</label>
                    <p class="error" id="registerEmailError">Por favor, introduce un correo v√°lido.</p>
                    <p class="success" id="registerEmailSuccess">Correo v√°lido ‚úì</p>
                </div>
                <div class="input-field">
                    <input type="password" id="registerPassword" required minlength="6">
                    <label for="registerPassword">Contrase√±a</label>
                    <p class="error" id="registerPasswordError">La contrase√±a debe tener al menos 6 caracteres.</p>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>
                <div class="input-field">
                    <input type="password" id="confirmPassword" required minlength="6">
                    <label for="confirmPassword">Confirmar contrase√±a</label>
                    <p class="error" id="confirmPasswordError">Las contrase√±as no coinciden.</p>
                    <p class="success" id="confirmPasswordSuccess">Las contrase√±as coinciden ‚úì</p>
                </div>
                <button type="submit">Crear Cuenta</button>
                <p class="toggle-link">
                    ¬øYa tienes cuenta? <span onclick="toggleForms()">Iniciar sesi√≥n</span>
                </p>
            </form>

            <!-- PANEL DE USUARIO LOGUEADO -->
            <div id="userPanel" class="form inactive">
                <div class="user-profile-header">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNmMGYwZjAiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM3IiByPSIxMyIgZmlsbD0iIzk5OSIvPjxwYXRoIGQ9Im0yNSA3NWMwLTE0IDExLTI1IDI1LTI1czI1IDExIDI1IDI1eiIgZmlsbD0iIzk5OSIvPjwvc3ZnPg=='">
                        <button class="change-photo-btn" onclick="changeProfilePhoto()">
                            <i class='bx bx-camera'></i>
                        </button>
                    </div>
                    <h2 id="userName">Usuario</h2>
                    <p id="userEmail" class="user-email">email@example.com</p>
                    <div class="user-status">
                        <span id="userStatus" class="status-badge">‚úÖ Perfil Completo</span>
                    </div>
                </div>

                <div class="user-info-section">
                    <h3>Informaci√≥n Personal</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <i class='bx bx-phone'></i>
                            <div>
                                <label>Tel√©fono</label>
                                <span id="userPhone">No registrado</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-id-card'></i>
                            <div>
                                <label>Documento</label>
                                <span id="userDocument">No registrado</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-map'></i>
                            <div>
                                <label>Ubicaci√≥n</label>
                                <span id="userLocation">No registrada</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-home'></i>
                            <div>
                                <label>Direcci√≥n</label>
                                <span id="userAddress">No registrada</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="user-actions">
                    <button type="button" class="edit-profile-btn" onclick="editProfile()">
                        <i class='bx bx-edit'></i> Editar Perfil
                    </button>
                    <button type="button" class="main-page-btn" onclick="goToMainPage()">
                        <i class='bx bx-home'></i> Ir a P√°gina Principal
                    </button>
                    <button type="button" class="logout-btn" onclick="logoutUser()">
                        <i class='bx bx-log-out'></i> Cerrar Sesi√≥n
                    </button>
                </div>

                <div class="account-info">
                    <small>Cuenta creada: <span id="accountCreated">--</span></small><br>
                    <small>√öltimo acceso: <span id="lastLogin">--</span></small>
                </div>
            </div>
            <form id="additionalDataForm" class="form inactive additional-data-form">
                <h2>Completa tu Perfil</h2>
                <p class="subtitle">Necesitamos algunos datos adicionales para personalizar tu experiencia</p>
                
                <!-- Tel√©fono -->
                <div class="phone-input-container">
                    <div class="input-field country-code">
                        <select id="countryCode" required>
                            <option value="+57">üá®üá¥ +57</option>
                        </select>
                        <label for="countryCode">Pa√≠s</label>
                    </div>
                    <div class="input-field phone-number">
                        <input type="tel" id="phoneNumber" required maxlength="10" pattern="[3][0-9]{9}">
                        <label for="phoneNumber">N√∫mero de tel√©fono</label>
                        <p class="error" id="phoneError">Ingresa un n√∫mero v√°lido (debe iniciar con 3)</p>
                        <p class="success" id="phoneSuccess">N√∫mero v√°lido ‚úì</p>
                    </div>
                </div>

                <!-- Documento -->
                <div class="document-container">
                    <div class="input-field document-type">
                        <select id="documentType" required>
                            <option value="">Tipo</option>
                            <option value="CC">C√©dula</option>
                            <option value="TI">Tarjeta ID</option>
                            <option value="CE">C√©dula Ext</option>
                            <option value="PP">Pasaporte</option>
                        </select>
                        <label for="documentType">Documento</label>
                    </div>
                    <div class="input-field document-number">
                        <input type="text" id="documentNumber" required maxlength="15" pattern="[0-9]+">
                        <label for="documentNumber">N√∫mero de documento</label>
                        <p class="error" id="documentError">Solo n√∫meros, sin puntos ni comas</p>
                        <p class="success" id="documentSuccess">Documento v√°lido ‚úì</p>
                    </div>
                </div>

                <!-- Ubicaci√≥n -->
                <div class="department-city-container">
                    <div class="input-field department-field">
                        <select id="department" required>
                            <option value="">Departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atl√°ntico">Atl√°ntico</option>
                            <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                            <option value="Bol√≠var">Bol√≠var</option>
                            <option value="Boyac√°">Boyac√°</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquet√°">Caquet√°</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Choc√≥">Choc√≥</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guain√≠a">Guain√≠a</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nari√±o">Nari√±o</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quind√≠o">Quind√≠o</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaup√©s">Vaup√©s</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        <label for="department">Departamento</label>
                    </div>
                    <div class="input-field city-field">
                        <input type="text" id="city" required>
                        <label for="city">Ciudad</label>
                        <p class="error" id="cityError">Por favor, ingresa tu ciudad</p>
                    </div>
                </div>

                <!-- Direcci√≥n -->
                <div class="input-field">
                    <input type="text" id="address" required>
                    <label for="address">Direcci√≥n completa</label>
                    <p class="error" id="addressError">Por favor, ingresa tu direcci√≥n</p>
                </div>

                <button type="submit">Guardar y Continuar</button>
                <button type="button" class="skip-button" onclick="skipAdditionalData()">Completar m√°s tarde</button>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURACI√ìN DE FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCbemUTCYHJYcbiX5U4DaQuaJa8Mh6EdyY",
            authDomain: "login-pagina-9a2b2.firebaseapp.com",
            projectId: "login-pagina-9a2b2",
            storageBucket: "login-pagina-9a2b2.firebasestorage.app",
            messagingSenderId: "676654795358",
            appId: "1:676654795358:web:c455962c22670fd0b002cf",
            measurementId: "G-TE86DMGMBV"
        };

        // Inicializar Firebase
        let app, auth, db, storage;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            console.log('‚úÖ Firebase inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error al inicializar Firebase:', error);
            alert('Error de configuraci√≥n de Firebase. Revisa la consola para m√°s detalles.');
        }

        // ========== VARIABLES GLOBALES ==========
        let currentForm = 'login'; // 'login', 'register', 'additionalData'
        let currentUser = null;

        // ========== PANTALLA DE CARGA ==========
        window.addEventListener('load', function() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.add('hidden');
                document.body.classList.remove('locked');
            }, 2000);
        });

        // ========== FUNCIONES DE NAVEGACI√ìN ==========
        function showForm(formName) {
            // Ocultar todos los formularios
            document.querySelectorAll('.form').forEach(form => {
                form.classList.remove('active');
                form.classList.add('inactive');
            });

            // Mostrar formulario espec√≠fico
            const targetForm = document.getElementById(formName + 'Form');
            if (targetForm) {
                targetForm.classList.remove('inactive');
                targetForm.classList.add('active');
                currentForm = formName;
            }
        }

        function toggleForms() {
            if (currentForm === 'login') {
                showForm('register');
            } else {
                showForm('login');
            }
            clearFormErrors();
        }

        function clearFormErrors() {
            document.querySelectorAll('.error').forEach(error => error.classList.remove('show'));
            document.querySelectorAll('.success').forEach(success => success.classList.remove('show'));
        }

        // ========== FUNCIONES DE VALIDACI√ìN ==========
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateColombianPhone(phone) {
            // N√∫meros colombianos: inician con 3 y tienen 10 d√≠gitos
            const phoneRegex = /^3[0-9]{9}$/;
            return phoneRegex.test(phone);
        }

        function validateDocument(docNumber) {
            // Solo n√∫meros, sin puntos ni comas
            const docRegex = /^[0-9]+$/;
            return docRegex.test(docNumber) && docNumber.length >= 6 && docNumber.length <= 15;
        }

        function checkPasswordStrength(password) {
            const strengthElement = document.getElementById('passwordStrength');
            let strength = 0;
            let message = '';
            
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            if (password.length < 6) {
                strengthElement.className = 'password-strength weak';
                message = 'Muy d√©bil - M√≠nimo 6 caracteres';
            } else if (strength <= 2) {
                strengthElement.className = 'password-strength weak';
                message = 'D√©bil - Usa may√∫sculas, n√∫meros y s√≠mbolos';
            } else if (strength <= 3) {
                strengthElement.className = 'password-strength medium';
                message = 'Media - Agrega m√°s variedad';
            } else {
                strengthElement.className = 'password-strength strong';
                message = 'Fuerte ‚úì';
            }
            
            strengthElement.textContent = message;
        }

        // ========== VALIDACI√ìN EN TIEMPO REAL ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Validaci√≥n de email en registro
            document.getElementById('registerEmail')?.addEventListener('input', function() {
                const email = this.value;
                const emailError = document.getElementById('registerEmailError');
                const emailSuccess = document.getElementById('registerEmailSuccess');
                
                if (email && validateEmail(email)) {
                    emailError.classList.remove('show');
                    emailSuccess.classList.add('show');
                } else if (email) {
                    emailSuccess.classList.remove('show');
                    emailError.classList.add('show');
                } else {
                    emailError.classList.remove('show');
                    emailSuccess.classList.remove('show');
                }
            });

            // Validaci√≥n de contrase√±a
            document.getElementById('registerPassword')?.addEventListener('input', function() {
                const password = this.value;
                if (password) {
                    checkPasswordStrength(password);
                } else {
                    document.getElementById('passwordStrength').style.display = 'none';
                }
            });

            // Validaci√≥n de confirmaci√≥n de contrase√±a
            document.getElementById('confirmPassword')?.addEventListener('input', function() {
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = this.value;
                const confirmError = document.getElementById('confirmPasswordError');
                const confirmSuccess = document.getElementById('confirmPasswordSuccess');
                
                if (confirmPassword && password === confirmPassword) {
                    confirmError.classList.remove('show');
                    confirmSuccess.classList.add('show');
                } else if (confirmPassword) {
                    confirmSuccess.classList.remove('show');
                    confirmError.classList.add('show');
                } else {
                    confirmError.classList.remove('show');
                    confirmSuccess.classList.remove('show');
                }
            });

            // Validaci√≥n de tel√©fono colombiano
            document.getElementById('phoneNumber')?.addEventListener('input', function() {
                const phone = this.value;
                const phoneError = document.getElementById('phoneError');
                const phoneSuccess = document.getElementById('phoneSuccess');
                
                if (phone && validateColombianPhone(phone)) {
                    phoneError.classList.remove('show');
                    phoneSuccess.classList.add('show');
                } else if (phone) {
                    phoneSuccess.classList.remove('show');
                    phoneError.classList.add('show');
                } else {
                    phoneError.classList.remove('show');
                    phoneSuccess.classList.remove('show');
                }
            });

            // Validaci√≥n de documento
            document.getElementById('documentNumber')?.addEventListener('input', function() {
                const docNumber = this.value;
                const docError = document.getElementById('documentError');
                const docSuccess = document.getElementById('documentSuccess');
                
                if (docNumber && validateDocument(docNumber)) {
                    docError.classList.remove('show');
                    docSuccess.classList.add('show');
                } else if (docNumber) {
                    docSuccess.classList.remove('show');
                    docError.classList.add('show');
                } else {
                    docError.classList.remove('show');
                    docSuccess.classList.remove('show');
                }
            });
        });

        // ========== FUNCIONES DE AUTENTICACI√ìN ==========
        async function registerWithFirebase(email, password, name) {
            try {
                console.log('üìù Creando usuario:', email);
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ Usuario creado en Auth:', user.uid);
                
                await user.updateProfile({ displayName: name });
                
                const userData = {
                    name: name,
                    email: email,
                    createdAt: new Date().toISOString(),
                    emailVerified: false,
                    provider: 'email',
                    uid: user.uid,
                    profileComplete: false, // Indica si complet√≥ datos adicionales
                    photoURL: null
                };
                
                await db.collection('users').doc(user.uid).set(userData);
                console.log('‚úÖ Usuario guardado en Firestore');
                
                try {
                    await user.sendEmailVerification();
                    console.log('üìß Email de verificaci√≥n enviado');
                } catch (emailError) {
                    console.warn('‚ö†Ô∏è No se pudo enviar email de verificaci√≥n:', emailError);
                }
                
                return {
                    success: true,
                    user: userData
                };
            } catch (error) {
                console.error('‚ùå Error en registro:', error);
                return {
                    success: false,
                    error: error.code,
                    message: getFirebaseErrorMessage(error.code)
                };
            }
        }

        async function loginWithEmail(email, password) {
            try {
                console.log('üîê Intentando login con:', email);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ Login exitoso:', user.uid);
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                return {
                    success: true,
                    user: {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || userData?.name || 'Usuario',
                        emailVerified: user.emailVerified,
                        profileComplete: userData?.profileComplete || false,
                        ...userData
                    }
                };
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                return {
                    success: false,
                    error: error.code,
                    message: getFirebaseErrorMessage(error.code)
                };
            }
        }

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                console.log('‚úÖ Login con Google exitoso:', user.uid);
                
                // Verificar si el usuario ya tiene datos adicionales
                const userDoc = await db.collection('users').doc(user.uid).get();
                let userData;
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    // Actualizar √∫ltima conexi√≥n
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString()
                    });
                } else {
                    // Primer login con Google, crear documento
                    userData = {
                        name: user.displayName,
                        email: user.email,
                        createdAt: new Date().toISOString(),
                        provider: 'google',
                        emailVerified: user.emailVerified,
                        photoURL: user.photoURL,
                        uid: user.uid,
                        profileComplete: false,
                        lastLogin: new Date().toISOString()
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                }
                
                return {
                    success: true,
                    user: {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName,
                        photoURL: user.photoURL,
                        provider: 'google',
                        emailVerified: user.emailVerified,
                        profileComplete: userData.profileComplete || false,
                        ...userData
                    }
                };
            } catch (error) {
                console.error('‚ùå Error en login con Google:', error);
                return {
                    success: false,
                    error: error.code,
                    message: getFirebaseErrorMessage(error.code)
                };
            }
        }

        async function saveAdditionalData(userData) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('No hay usuario autenticado');
                
                const additionalData = {
                    phone: userData.phone,
                    documentType: userData.documentType,
                    documentNumber: userData.documentNumber,
                    department: userData.department,
                    city: userData.city,
                    address: userData.address,
                    profileComplete: true,
                    profileCompletedAt: new Date().toISOString()
                };
                
                await db.collection('users').doc(user.uid).update(additionalData);
                console.log('‚úÖ Datos adicionales guardados');
                
                return { success: true };
            } catch (error) {
                console.error('‚ùå Error guardando datos adicionales:', error);
                return { success: false, message: error.message };
            }
        }

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'No existe una cuenta con este correo electr√≥nico.',
                'auth/wrong-password': 'Contrase√±a incorrecta.',
                'auth/email-already-in-use': 'Ya existe una cuenta con este correo electr√≥nico.',
                'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres.',
                'auth/invalid-email': 'El correo electr√≥nico no es v√°lido.',
                'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde.',
                'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet.',
                'auth/popup-closed-by-user': 'Ventana de autenticaci√≥n cerrada.',
                'auth/cancelled-popup-request': 'Solicitud cancelada.',
                'default': 'Error de autenticaci√≥n. Intenta nuevamente.'
            };
            return messages[errorCode] || messages['default'];
        }

        // ========== GESTI√ìN DE SESI√ìN Y PANEL DE USUARIO ==========
        function showUserPanel(user) {
            console.log('üë§ Mostrando panel de usuario:', user.name);
            
            // Actualizar informaci√≥n del usuario en el panel
            document.getElementById('userName').textContent = user.name || 'Usuario';
            document.getElementById('userEmail').textContent = user.email || '';
            
            // Avatar
            const avatar = document.getElementById('userAvatar');
            if (user.photoURL) {
                avatar.src = user.photoURL;
            }
            
            // Estado del perfil
            const statusElement = document.getElementById('userStatus');
            if (user.profileComplete) {
                statusElement.textContent = '‚úÖ Perfil Completo';
                statusElement.className = 'status-badge complete';
            } else {
                statusElement.textContent = '‚ö†Ô∏è Perfil Incompleto';
                statusElement.className = 'status-badge incomplete';
            }
            
            // Informaci√≥n personal
            document.getElementById('userPhone').textContent = user.phone || 'No registrado';
            document.getElementById('userDocument').textContent = 
                user.documentType && user.documentNumber ? 
                `${user.documentType} ${user.documentNumber}` : 'No registrado';
            document.getElementById('userLocation').textContent = 
                user.city && user.department ? 
                `${user.city}, ${user.department}` : 'No registrada';
            document.getElementById('userAddress').textContent = user.address || 'No registrada';
            
            // Fechas
            if (user.createdAt) {
                const createdDate = new Date(user.createdAt).toLocaleDateString('es-CO');
                document.getElementById('accountCreated').textContent = createdDate;
            }
            
            if (user.lastLogin) {
                const lastLoginDate = new Date(user.lastLogin).toLocaleString('es-CO');
                document.getElementById('lastLogin').textContent = lastLoginDate;
            }
            
            // Mostrar panel de usuario
            showForm('user');
        }

        function showForm(formName) {
            // Ocultar todos los formularios
            document.querySelectorAll('.form').forEach(form => {
                form.classList.remove('active');
                form.classList.add('inactive');
            });

            // Mostrar formulario espec√≠fico
            let targetForm;
            if (formName === 'user') {
                targetForm = document.getElementById('userPanel');
            } else {
                targetForm = document.getElementById(formName + 'Form');
            }
            
            if (targetForm) {
                targetForm.classList.remove('inactive');
                targetForm.classList.add('active');
                currentForm = formName;
            }
        }

        async function checkExistingSession() {
            return new Promise((resolve) => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    unsubscribe(); // Dejar de escuchar despu√©s de la primera verificaci√≥n
                    
                    if (user) {
                        console.log('üîç Usuario ya autenticado encontrado:', user.email);
                        
                        try {
                            // Obtener datos completos del usuario desde Firestore
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            const userData = userDoc.data();
                            
                            const completeUser = {
                                uid: user.uid,
                                email: user.email,
                                name: user.displayName || userData?.name || 'Usuario',
                                emailVerified: user.emailVerified,
                                photoURL: user.photoURL || userData?.photoURL,
                                profileComplete: userData?.profileComplete || false,
                                ...userData
                            };
                            
                            currentUser = completeUser;
                            showUserPanel(completeUser);
                            resolve(true);
                        } catch (error) {
                            console.error('Error obteniendo datos del usuario:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('üë§ No hay usuario autenticado');
                        showForm('login');
                        resolve(false);
                    }
                });
            });
        }

        // ========== FUNCIONES DEL PANEL DE USUARIO ==========
        function editProfile() {
            if (currentUser) {
                if (!currentUser.profileComplete) {
                    // Si no tiene perfil completo, mostrar formulario de datos adicionales
                    showForm('additionalData');
                    
                    // Pre-llenar campos si existen datos parciales
                    if (currentUser.phone) {
                        const phone = currentUser.phone.replace('+57', '');
                        document.getElementById('phoneNumber').value = phone;
                    }
                    if (currentUser.documentType) {
                        document.getElementById('documentType').value = currentUser.documentType;
                    }
                    if (currentUser.documentNumber) {
                        document.getElementById('documentNumber').value = currentUser.documentNumber;
                    }
                    if (currentUser.department) {
                        document.getElementById('department').value = currentUser.department;
                    }
                    if (currentUser.city) {
                        document.getElementById('city').value = currentUser.city;
                    }
                    if (currentUser.address) {
                        document.getElementById('address').value = currentUser.address;
                    }
                } else {
                    alert('üîß Editor de perfil completo en desarrollo\n\n' +
                          'Por ahora puedes:\n' +
                          '‚Ä¢ Cambiar foto de perfil\n' +
                          '‚Ä¢ Cerrar sesi√≥n para usar otra cuenta\n' +
                          '‚Ä¢ Ir a la p√°gina principal');
                }
            }
        }

        function goToMainPage() {
            if (currentUser) {
                redirectToMainPage(currentUser);
            }
        }

        function logoutUser() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                auth.signOut().then(() => {
                    console.log('üëã Sesi√≥n cerrada');
                    currentUser = null;
                    sessionStorage.removeItem('currentUser');
                    showForm('login');
                    
                    // Limpiar formularios
                    document.querySelectorAll('form').forEach(form => form.reset());
                    clearFormErrors();
                    
                    alert('‚úÖ Sesi√≥n cerrada exitosamente');
                }).catch((error) => {
                    console.error('Error al cerrar sesi√≥n:', error);
                    alert('‚ùå Error al cerrar sesi√≥n');
                });
            }
        }

        function changeProfilePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handlePhotoUpload;
            input.click();
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            
            // Validar tama√±o (m√°ximo 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå La imagen es muy grande. M√°ximo 2MB permitido.');
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Por favor selecciona una imagen v√°lida.');
                return;
            }
            
            try {
                console.log('üì∏ Subiendo foto de perfil...');
                
                // Crear referencia de storage
                const storageRef = storage.ref(`profile_photos/${currentUser.uid}/${Date.now()}_${file.name}`);
                
                // Subir archivo
                const uploadTask = storageRef.put(file);
                
                // Mostrar progreso
                const changeBtn = document.querySelector('.change-photo-btn');
                changeBtn.innerHTML = '<i class="bx bx-loader bx-spin"></i>';
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Progreso
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Progreso:', progress.toFixed(0) + '%');
                    },
                    (error) => {
                        // Error
                        console.error('Error subiendo foto:', error);
                        alert('‚ùå Error subiendo la foto');
                        changeBtn.innerHTML = '<i class="bx bx-camera"></i>';
                    },
                    async () => {
                        // Completado
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            // Actualizar perfil de Firebase Auth
                            await auth.currentUser.updateProfile({
                                photoURL: downloadURL
                            });
                            
                            // Actualizar Firestore
                            await db.collection('users').doc(currentUser.uid).update({
                                photoURL: downloadURL,
                                updatedAt: new Date().toISOString()
                            });
                            
                            // Actualizar UI
                            document.getElementById('userAvatar').src = downloadURL;
                            currentUser.photoURL = downloadURL;
                            
                            changeBtn.innerHTML = '<i class="bx bx-camera"></i>';
                            
                            console.log('‚úÖ Foto de perfil actualizada');
                            alert('‚úÖ Foto de perfil actualizada correctamente');
                            
                        } catch (error) {
                            console.error('Error actualizando foto:', error);
                            alert('‚ùå Error actualizando la foto');
                            changeBtn.innerHTML = '<i class="bx bx-camera"></i>';
                        }
                    }
                );
                
            } catch (error) {
                console.error('Error general subiendo foto:', error);
                alert('‚ùå Error subiendo la foto');
            }
        }
        function redirectToMainPage(user) {
            // Guardar datos del usuario en sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            
            console.log('üöÄ Redirigiendo a p√°gina principal...');
            alert(`¬°Bienvenido ${user.name}! üéâ\n\nRedirigiendo a la p√°gina principal...`);
            
            // Simular redirecci√≥n (cambiar por tu p√°gina real)
            setTimeout(() => {
                window.location.href = 'principal.html';
            }, 2000);
        }

        function handlePostLogin(user) {
            currentUser = user;
            
            if (!user.profileComplete) {
                console.log('üìã Usuario necesita completar perfil');
                showForm('additionalData');
            } else {
                console.log('‚úÖ Usuario con perfil completo');
                redirectToMainPage(user);
            }
        }

        function skipAdditionalData() {
            if (currentUser) {
                console.log('‚è≠Ô∏è Usuario salt√≥ datos adicionales');
                redirectToMainPage(currentUser);
            }
        }

        // ========== FORMULARIOS ==========
        
        // Login con email/contrase√±a
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('remember').checked;
            const submitButton = this.querySelector('button[type="submit"]');
            
            clearFormErrors();
            
            let hasErrors = false;
            
            if (!email || !validateEmail(email)) {
                document.getElementById('loginEmailError').classList.add('show');
                hasErrors = true;
            }
            
            if (!password || password.length < 6) {
                document.getElementById('loginPasswordError').classList.add('show');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            submitButton.textContent = 'Iniciando sesi√≥n...';
            submitButton.disabled = true;
            
            const result = await loginWithEmail(email, password);
            
            if (result.success) {
                submitButton.textContent = '¬°Bienvenido!';
                submitButton.style.background = '#28a745';
                
                // Guardar email si est√° marcado recordar
                if (remember) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }
                
                setTimeout(() => {
                    handlePostLogin(result.user);
                }, 1000);
                
            } else {
                submitButton.textContent = 'Error de acceso';
                submitButton.style.background = '#dc3545';
                
                if (result.error === 'auth/user-not-found') {
                    document.getElementById('loginEmailError').textContent = result.message;
                    document.getElementById('loginEmailError').classList.add('show');
                } else if (result.error === 'auth/wrong-password') {
                    document.getElementById('loginPasswordError').textContent = result.message;
                    document.getElementById('loginPasswordError').classList.add('show');
                }
                
                setTimeout(() => {
                    resetButton(submitButton, 'Entrar');
                }, 2000);
            }
        });

        // Registro
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = this.querySelector('button[type="submit"]');
            
            clearFormErrors();
            
            let hasErrors = false;
            
            if (!name || name.length < 2) {
                document.getElementById('registerNameError').textContent = 'El nombre debe tener al menos 2 caracteres.';
                document.getElementById('registerNameError').classList.add('show');
                hasErrors = true;
            }
            
            if (!email || !validateEmail(email)) {
                document.getElementById('registerEmailError').textContent = 'Por favor, introduce un correo v√°lido.';
                document.getElementById('registerEmailError').classList.add('show');
                hasErrors = true;
            }
            
            if (!password || password.length < 6) {
                document.getElementById('registerPasswordError').textContent = 'La contrase√±a debe tener al menos 6 caracteres.';
                document.getElementById('registerPasswordError').classList.add('show');
                hasErrors = true;
            }
            
            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').textContent = 'Las contrase√±as no coinciden.';
                document.getElementById('confirmPasswordError').classList.add('show');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            submitButton.textContent = 'Creando cuenta...';
            submitButton.disabled = true;
            
            const result = await registerWithFirebase(email, password, name);
            
            if (result.success) {
                submitButton.textContent = '¬°Cuenta creada!';
                submitButton.style.background = '#28a745';
                
                setTimeout(() => {
                    handlePostLogin(result.user);
                }, 1000);
                
            } else {
                submitButton.textContent = 'Error al crear cuenta';
                submitButton.style.background = '#dc3545';
                
                if (result.error === 'auth/email-already-in-use') {
                    document.getElementById('registerEmailError').textContent = result.message;
                    document.getElementById('registerEmailError').classList.add('show');
                } else if (result.error === 'auth/weak-password') {
                    document.getElementById('registerPasswordError').textContent = result.message;
                    document.getElementById('registerPasswordError').classList.add('show');
                }
                
                setTimeout(() => {
                    resetButton(submitButton, 'Crear Cuenta');
                }, 2000);
            }
        });

        // Datos adicionales
        document.getElementById('additionalDataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('phoneNumber').value;
            const documentType = document.getElementById('documentType').value;
            const documentNumber = document.getElementById('documentNumber').value;
            const department = document.getElementById('department').value;
            const city = document.getElementById('city').value.trim();
            const address = document.getElementById('address').value.trim();
            const submitButton = this.querySelector('button[type="submit"]');
            
            clearFormErrors();
            
            let hasErrors = false;
            
            if (!phone || !validateColombianPhone(phone)) {
                document.getElementById('phoneError').classList.add('show');
                hasErrors = true;
            }
            
            if (!documentType || !documentNumber || !validateDocument(documentNumber)) {
                document.getElementById('documentError').classList.add('show');
                hasErrors = true;
            }
            
            if (!city) {
                document.getElementById('cityError').classList.add('show');
                hasErrors = true;
            }
            
            if (!address) {
                document.getElementById('addressError').classList.add('show');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            submitButton.textContent = 'Guardando datos...';
            submitButton.disabled = true;
            
            const userData = {
                phone: `+57${phone}`,
                documentType,
                documentNumber,
                department,
                city,
                address
            };
            
            const result = await saveAdditionalData(userData);
            
            if (result.success) {
                submitButton.textContent = '¬°Datos guardados!';
                submitButton.style.background = '#28a745';
                
                // Actualizar usuario actual
                currentUser.profileComplete = true;
                currentUser = { ...currentUser, ...userData };
                
                setTimeout(() => {
                    redirectToMainPage(currentUser);
                }, 1000);
                
            } else {
                submitButton.textContent = 'Error al guardar';
                submitButton.style.background = '#dc3545';
                
                setTimeout(() => {
                    resetButton(submitButton, 'Guardar y Continuar');
                }, 2000);
            }
        });

        // Login con Google
        document.getElementById('googleSignInButton').addEventListener('click', async function() {
            const button = this;
            button.textContent = 'Conectando con Google...';
            button.disabled = true;
            
            const result = await loginWithGoogle();
            
            if (result.success) {
                button.textContent = '¬°Bienvenido!';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    handlePostLogin(result.user);
                }, 1000);
            } else {
                button.textContent = 'Error con Google';
                button.style.background = '#dc3545';
                
                setTimeout(() => {
                    resetButton(button, 'Iniciar sesi√≥n con Google');
                }, 2000);
            }
        });

        // Facebook (placeholder)
        document.querySelector('.facebook-button').addEventListener('click', function() {
            alert('üîß Facebook Login en desarrollo');
        });

        function resetButton(button, originalText) {
            button.textContent = originalText;
            button.disabled = false;
            button.style.background = '';
        }

        // ========== FUNCIONES DE UTILIDAD ==========
        function loadRememberedEmail() {
            const remembered = localStorage.getItem('rememberedEmail');
            if (remembered) {
                document.getElementById('loginEmail').value = remembered;
                document.getElementById('remember').checked = true;
            }
        }

        function showFirebaseUsers() {
            if (!db) return;
            
            db.collection('users').get().then((querySnapshot) => {
                console.log('=== USUARIOS EN FIREBASE ===');
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log(`${doc.id}:`, {
                        nombre: data.name,
                        email: data.email,
                        telefono: data.phone || 'No registrado',
                        documento: data.documentNumber || 'No registrado',
                        ciudad: data.city || 'No registrada',
                        perfilCompleto: data.profileComplete ? 'S√≠' : 'No'
                    });
                });
                console.log(`Total de usuarios: ${querySnapshot.size}`);
            });
        }

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inicializando sistema...');
            
            // Verificar si hay una sesi√≥n activa
            const hasActiveSession = await checkExistingSession();
            
            if (!hasActiveSession) {
                // No hay sesi√≥n activa, cargar email recordado
                loadRememberedEmail();
            }
            
            // Funciones globales disponibles
            window.showFirebaseUsers = showFirebaseUsers;
            window.toggleForms = toggleForms;
            window.skipAdditionalData = skipAdditionalData;
            window.editProfile = editProfile;
            window.goToMainPage = goToMainPage;
            window.logoutUser = logoutUser;
            window.changeProfilePhoto = changeProfilePhoto;
            
            console.log('=== SISTEMA COMPLETO DE AUTENTICACI√ìN ===');
            console.log('‚úÖ Detecci√≥n autom√°tica de sesi√≥n activa');
            console.log('‚úÖ Panel de usuario personalizado');
            console.log('‚úÖ Edici√≥n de foto de perfil');
            console.log('‚úÖ Login con email/contrase√±a');
            console.log('‚úÖ Login con Google');
            console.log('‚úÖ Registro de usuarios');
            console.log('‚úÖ Formulario de datos adicionales');
            console.log('‚úÖ Validaci√≥n colombiana');
            console.log('\nüéØ Funciones disponibles:');
            console.log('‚Ä¢ showFirebaseUsers() - Ver usuarios registrados');
            console.log('\nüöÄ ¬°Sistema completamente funcional!');
        });

        // Monitoreo de autenticaci√≥n
        auth?.onAuthStateChanged(function(user) {
            if (user && currentForm !== 'additionalData') {
                console.log('üë§ Usuario ya autenticado:', user.email);
            }
        });
    </script>
</body>
</html>